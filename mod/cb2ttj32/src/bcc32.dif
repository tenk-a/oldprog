*** orig/array.cpp	Thu Sep 24 00:53:44 1998
--- array.cpp	Thu Sep 24 00:53:18 1998
***************
*** 2,7 ****
--- 2,10 ----
  #include <afx.h>
  #include <malloc.h>
  #include <stdio.h>
+ #ifdef __BORLANDC__
+ # include "bcc.h"
+ #endif
  #include "ntuttf.h"
  #include "array.h"
  
*** orig/ttfstub.cpp	Thu Sep 24 00:55:06 1998
--- ttfstub.cpp	Thu Sep 24 00:55:12 1998
***************
*** 5,20 ****
  #include <stdio.h>
  #include <string.h>
  #include <malloc.h>
  #include "ntuttf.h"
  #include "array.h"
  
  #define NFONT 2
  #define EFONT 94
! #define RFONT 5809
! #define CFONT 13502
! #define EachFont 157
! #define EachSeg 191
! #define EachOff (EachSeg-EachFont)
  
  #define numTbl 13
  #define OS2  0
--- 5,32 ----
  #include <stdio.h>
  #include <string.h>
  #include <malloc.h>
+ #ifdef __BORLANDC__
+ # include "bcc.h"
+ #endif
  #include "ntuttf.h"
  #include "array.h"
  
  #define NFONT 2
  #define EFONT 94
! #ifdef SJIS
! # include <mbstring.h>
! # define RFONT 0
! # define CFONT 8836
! # define EachFont 188
! # define EachSeg 189
! # define EachOff (EachSeg-EachFont)
! #else
! # define RFONT 5809
! # define CFONT 13502
! # define EachFont 157
! # define EachSeg 191
! # define EachOff (EachSeg-EachFont)
! #endif
  
  #define numTbl 13
  #define OS2  0
***************
*** 100,107 ****
     0x18}; //round to grid
  
  /* Eng translate from ASCII 0x21 to 0x7E total 94 fonts*/
  unsigned char ptn_2byte[189] =
! "¡I¡¨¡­¢C¢H¡®¡¦¡]¡^¡¯¡Ï¡A¡Ð¡D¡þ¢¯¢°¢±¢²¢³¢´¢µ¢¶¢·¢¸¡G¡F¡Õ¡×¡Ö¡H¢I¢Ï¢Ð¢Ñ¢Ò¢Ó¢Ô¢Õ¢Ö¢×¢Ø¢Ù¢Ú¢Û¢Ü¢Ý¢Þ¢ß¢à¢á¢â¢ã¢ä¢å¢æ¢ç¢è¡e¢@¡f¡s¡Å¡¥¢é¢ê¢ë¢ì¢í¢î¢ï¢ð¢ñ¢ò¢ó¢ô¢õ¢ö¢÷¢ø¢ù¢ú¢û¢ü¢ý¢þ£@£A£B£C¡a¡U¡b¡ã";
  
  char *id_str, *idc_str;
  
--- 112,124 ----
     0x18}; //round to grid
  
  /* Eng translate from ASCII 0x21 to 0x7E total 94 fonts*/
+ #ifdef SJIS
  unsigned char ptn_2byte[189] =
! "Ih”“•fij–{C|D^‚O‚P‚Q‚R‚S‚T‚U‚V‚W‚XFGƒ„H—‚`‚a‚b‚c‚d‚e‚f‚g‚h‚i‚j‚k‚l‚m‚n‚o‚p‚q‚r‚s‚t‚u‚v‚w‚x‚ymnOQ@‚‚‚‚ƒ‚„‚…‚†‚‡‚ˆ‚‰‚Š‚‹‚Œ‚‚Ž‚‚‚‘‚’‚“‚”‚•‚–‚—‚˜‚™‚šobpP";
! #else
! unsigned char ptn_2byte[189] =
! "¡I¡¨¡­¢C¢H¡®¡¦¡]¡^¡¯¡Ï¡A¡Ð¡D¡þ¢¯¢°¢±¢²¢³¢´¢µ¢¶¢·¢¸¡G¡F¡Õ¡×¡Ö¡H¢I¢Ï¢Ð¢Ñ¢Ò¢Ó¢Ô¢Õ¢Ö¢×¢Ø¢Ù¢Ú¢Û¢Ü¢Ý¢Þ¢ß¢à¢á¢â¢ã¢ä¢å¢æ¢ç¢è¡e¢@¡f¡s¡Å¡¥¢é¢ê¢ë¢ì¢í¢î¢ï¢ð¢ñ¢ò¢ó¢ô¢õ¢ö¢÷¢ø¢ù¢ú¢û¢ü¢ý¢þ£@£A£B£C¡a¡U¡b¡\xa1\xe3";
! #endif
  
  char *id_str, *idc_str;
  
***************
*** 183,188 ****
--- 200,206 ----
       bigfirst sob;  //Make string packing
       short cp, cpl, ide, idel, st, stl, vs, vsl, td, tdl, idc, idcl;
       short cp2, cp2l, ide2, ide2l, st2, st2l, vs2, vs2l, td2, td2l, i;
+      table *tmp = &ttfTbl[NAME];
       cp = sob.getlen();   cpl = strlen(cprite);  cp2l = 2*cpl;
       addstr(sob,cprite); cp2 = sob.getlen();  addstr2(sob,cprite);
       ide = sob.getlen();  idel = strlen(id_str); ide2l = 2*idel;
***************
*** 193,200 ****
       addstr(sob,version); vs2 = sob.getlen();  addstr2(sob,version);
       td = sob.getlen();   tdl = strlen(trade);   td2l = 2*tdl;
       addstr(sob,trade); td2 = sob.getlen();  addstr2(sob,trade);
       idc = sob.getlen();  idcl = strlen(idc_str); addstr(sob,idc_str);
-      table *tmp = &ttfTbl[NAME];
       tmp->addshort(0); tmp->addshort(32); /* #NameRec */
       tmp->addshort(6+32*12); /* offset of strorage */
       /* plateform 1 */
--- 211,300 ----
       addstr(sob,version); vs2 = sob.getlen();  addstr2(sob,version);
       td = sob.getlen();   tdl = strlen(trade);   td2l = 2*tdl;
       addstr(sob,trade); td2 = sob.getlen();  addstr2(sob,trade);
+ #ifdef SJIS
+      {	/* Unicode coversion */
+         WCHAR tmp[80];
+         idc = sob.getlen();
+         idcl = MultiByteToWideChar(CP_ACP, MB_PRECOMPOSED,
+                                    idc_str, -1, tmp, 80) - 1;
+         for (i = 0; i < idcl; i++) {
+             sob.addbyte(tmp[i] >> 8);
+             sob.addbyte(tmp[i] & 0xff);
+         }
+      idcl *= 2;
+      }
+      tmp->addshort(0); tmp->addshort(32); /* #NameRec */
+      tmp->addshort(6+32*12); /* offset of strorage */
+      /* plateform 1 */
+      tmp->addshort(1); tmp->addshort(0); tmp->addshort(11); tmp->addshort(0);
+      tmp->addshort(cpl); tmp->addshort(cp); /* Copyrite */
+      tmp->addshort(1); tmp->addshort(0); tmp->addshort(11); tmp->addshort(1);
+      tmp->addshort(idel); tmp->addshort(ide); /* IDe */
+      tmp->addshort(1); tmp->addshort(0); tmp->addshort(11); tmp->addshort(2);
+      tmp->addshort(stl); tmp->addshort(st); /* Style */
+      tmp->addshort(1); tmp->addshort(0); tmp->addshort(11); tmp->addshort(3);
+      tmp->addshort(idel); tmp->addshort(ide); /* IDe */
+      tmp->addshort(1); tmp->addshort(0); tmp->addshort(11); tmp->addshort(4);
+      tmp->addshort(idel); tmp->addshort(ide); /* IDe */
+      tmp->addshort(1); tmp->addshort(0); tmp->addshort(11); tmp->addshort(5);
+      tmp->addshort(vsl); tmp->addshort(vs); /* Version */
+      tmp->addshort(1); tmp->addshort(0); tmp->addshort(11); tmp->addshort(6);
+      tmp->addshort(idel); tmp->addshort(ide); /* IDe */
+      tmp->addshort(1); tmp->addshort(0); tmp->addshort(11); tmp->addshort(7);
+      tmp->addshort(tdl); tmp->addshort(td); /* Trade */
+      /* plateform 2 */
+      tmp->addshort(1); tmp->addshort(1); tmp->addshort(11); tmp->addshort(0);
+      tmp->addshort(cp2l); tmp->addshort(cp2); /* Copyrite */
+      tmp->addshort(1); tmp->addshort(1); tmp->addshort(11); tmp->addshort(1);
+      tmp->addshort(idcl); tmp->addshort(idc); /* IDe */
+      tmp->addshort(1); tmp->addshort(1); tmp->addshort(11); tmp->addshort(2);
+      tmp->addshort(st2l); tmp->addshort(st2); /* Style */
+      tmp->addshort(1); tmp->addshort(1); tmp->addshort(11); tmp->addshort(3);
+      tmp->addshort(idcl); tmp->addshort(idc); /* IDe */
+      tmp->addshort(1); tmp->addshort(1); tmp->addshort(11); tmp->addshort(4);
+      tmp->addshort(idcl); tmp->addshort(idc); /* IDe */
+      tmp->addshort(1); tmp->addshort(1); tmp->addshort(11); tmp->addshort(5);
+      tmp->addshort(vs2l); tmp->addshort(vs2); /* Version */
+      tmp->addshort(1); tmp->addshort(1); tmp->addshort(11); tmp->addshort(6);
+      tmp->addshort(ide2l); tmp->addshort(ide2); /* IDe */
+      tmp->addshort(1); tmp->addshort(1); tmp->addshort(11); tmp->addshort(7);
+      tmp->addshort(td2l); tmp->addshort(td2); /* Trade */
+      /* plateform 3 */
+      tmp->addshort(3); tmp->addshort(1); tmp->addshort(1041); tmp->addshort(0);
+      tmp->addshort(cp2l); tmp->addshort(cp2); /* Copyrite */
+      tmp->addshort(3); tmp->addshort(1); tmp->addshort(1041); tmp->addshort(1);
+      tmp->addshort(ide2l); tmp->addshort(ide2); /* IDe */
+      tmp->addshort(3); tmp->addshort(1); tmp->addshort(1041); tmp->addshort(2);
+      tmp->addshort(st2l); tmp->addshort(st2); /* Style */
+      tmp->addshort(3); tmp->addshort(1); tmp->addshort(1041); tmp->addshort(3);
+      tmp->addshort(ide2l); tmp->addshort(ide2); /* IDe */
+      tmp->addshort(3); tmp->addshort(1); tmp->addshort(1041); tmp->addshort(4);
+      tmp->addshort(ide2l); tmp->addshort(ide2); /* IDe */
+      tmp->addshort(3); tmp->addshort(1); tmp->addshort(1041); tmp->addshort(5);
+      tmp->addshort(vs2l); tmp->addshort(vs2); /* Version */
+      tmp->addshort(3); tmp->addshort(1); tmp->addshort(1041); tmp->addshort(6);
+      tmp->addshort(ide2l); tmp->addshort(ide2); /* IDe */
+      tmp->addshort(3); tmp->addshort(1); tmp->addshort(1041); tmp->addshort(7);
+      tmp->addshort(td2l); tmp->addshort(td2); /* Trade */
+      /* plateform 4 */
+      tmp->addshort(3); tmp->addshort(2); tmp->addshort(1041); tmp->addshort(0);
+      tmp->addshort(cp2l); tmp->addshort(cp2); /* Copyrite */
+      tmp->addshort(3); tmp->addshort(2); tmp->addshort(1041); tmp->addshort(1);
+      tmp->addshort(idcl); tmp->addshort(idc); /* IDe */
+      tmp->addshort(3); tmp->addshort(2); tmp->addshort(1041); tmp->addshort(2);
+      tmp->addshort(st2l); tmp->addshort(st2); /* Style */
+      tmp->addshort(3); tmp->addshort(2); tmp->addshort(1041); tmp->addshort(3);
+      tmp->addshort(idcl); tmp->addshort(idc); /* IDe */
+      tmp->addshort(3); tmp->addshort(2); tmp->addshort(1041); tmp->addshort(4);
+      tmp->addshort(idcl); tmp->addshort(idc); /* IDe */
+      tmp->addshort(3); tmp->addshort(2); tmp->addshort(1041); tmp->addshort(5);
+      tmp->addshort(vs2l); tmp->addshort(vs2); /* Version */
+      tmp->addshort(3); tmp->addshort(2); tmp->addshort(1041); tmp->addshort(6);
+      tmp->addshort(ide2l); tmp->addshort(ide2); /* IDe */
+      tmp->addshort(3); tmp->addshort(2); tmp->addshort(1041); tmp->addshort(7);
+      tmp->addshort(td2l); tmp->addshort(td2); /* Trade */
+ #else
       idc = sob.getlen();  idcl = strlen(idc_str); addstr(sob,idc_str);
       tmp->addshort(0); tmp->addshort(32); /* #NameRec */
       tmp->addshort(6+32*12); /* offset of strorage */
       /* plateform 1 */
***************
*** 265,270 ****
--- 365,371 ----
       tmp->addshort(ide2l); tmp->addshort(ide2); /* IDe */
       tmp->addshort(3); tmp->addshort(4); tmp->addshort(1028); tmp->addshort(7);
       tmp->addshort(td2l); tmp->addshort(td2); /* Trade */
+ #endif
       for (i = 0; i < (short)sob.getlen(); i++) tmp->addbyte(sob[i]);
       tmp->chksum4();
       tmp->len = tmp->getlen();
***************
*** 274,280 ****
       { while (*str) st.addbyte(*str++); }
  
  void addstr2(bigfirst &st, char *str)
!      { while (*str) { st.addbyte('\0'; st.addbyte(*str++); } }
  
  void gene_profile()
       { //gene head, hhea, hmtx, maxp, lyjs and post
--- 375,381 ----
       { while (*str) st.addbyte(*str++); }
  
  void addstr2(bigfirst &st, char *str)
!      { while (*str) { st.addbyte('\0'); st.addbyte(*str++); } }
  
  void gene_profile()
       { //gene head, hhea, hmtx, maxp, lyjs and post
***************
*** 386,391 ****
--- 487,642 ----
       unsigned short idOff;
       };
  
+ #ifdef SJIS
+ void gene_cmap()
+      {
+      bigfirst fmat0, fmat2, fmat4, glyf_index;
+      short i, j, base, fnum, segCnt;
+      unsigned short start, *head_ary, *end_ary, *dlt_ary, *off_ary;
+      struct cmap_sh *sub_ary;
+      fmat0.addshort(0); /* format */
+      fmat0.addshort(262); /* len */
+      fmat0.addshort(0); /* Revision */
+      for (i = 0; i <= 32; i++) fmat0.addbyte(0);
+      for (; i <= 0x7e; i++) fmat0.addbyte((unsigned char)(i-32+1));
+      for (; i < 256; i++) fmat0.addbyte(0);
+      /* follow make format 2 */
+      head_ary = new unsigned short[256];
+      for (i = 0; i < 128; i++) head_ary[i] = 0; /* English */
+      for (; i < 0x81; i++) head_ary[i] = 1; /* Ununsed */
+      for (j = 2; i <= 0x9f; i++) head_ary[i] = j++; /* First segment */
+      for (; i < 0xe0; i++) head_ary[i] = 1;
+      for (; i <= 0xfe; i++) head_ary[i] = j++; /* Sec segment */
+      for (; i < 256; i++) head_ary[i] = 1;
+      for (i = 0; i < 256; i++) head_ary[i] *= 8;
+      sub_ary = new struct cmap_sh[j];
+      sub_ary[0].fCod = 0; sub_ary[0].numEnt = 256; sub_ary[0].idDelta = 0;
+      sub_ary[1].fCod = 64;
+      sub_ary[1].numEnt = sub_ary[1].idDelta = sub_ary[1].idOff = 0;
+      /* 0x8140 -- 0x9ffc */
+      for (fnum = EachFont*31, base = 0, i = 2; fnum > 0;
+          i++,base += ((fnum > EachFont)?EachFont:fnum), fnum -= EachFont)
+          {
+          sub_ary[i].fCod = 64;
+          sub_ary[i].numEnt =
+              (fnum > EachFont)?EachSeg:((fnum <= 63)?fnum:(fnum+EachOff));
+          sub_ary[i].idDelta = base;
+          }
+      /* 0xe040 -- 0xeffc */
+      for (fnum = EachFont*16, base = EachFont*31; fnum > 0;
+          i++,base += ((fnum > EachFont)?EachFont:fnum), fnum -= EachFont)
+          {
+          sub_ary[i].fCod = 64;
+          sub_ary[i].numEnt =
+              (fnum > EachFont)?EachSeg:((fnum <= 63)?fnum:(fnum+EachOff));
+          sub_ary[i].idDelta = base;
+          }
+      sub_ary[j-1].idOff = 2;
+      for (i = j-2; i >= 2; i--) sub_ary[i].idOff = sub_ary[i+1].idOff + 8;
+      sub_ary[0].idOff = (j-1)*8+2+EachSeg*2;
+      make_gidx(glyf_index);
+      fmat2.addshort(2); /* format */
+      fmat2.addshort(6+256*2+j*8+glyf_index.getlen()); /* len */
+      fmat2.addshort(0);
+      for (i = 0; i < 256; i++) fmat2.addshort(head_ary[i]);
+      delete head_ary;
+      for (i = 0; i < j; i++)
+          {
+          fmat2.addshort(sub_ary[i].fCod);
+          fmat2.addshort(sub_ary[i].numEnt);
+          fmat2.addshort(sub_ary[i].idDelta);
+          fmat2.addshort(sub_ary[i].idOff);
+          }
+      delete sub_ary;
+      for (i = 0; i < (short)glyf_index.getlen(); i++)
+          fmat2.addbyte(glyf_index[i]);
+ 
+      // follow make format 4
+      segCnt = 1 + 31 + 16 + 1;
+      head_ary = new unsigned short[segCnt+1];
+      end_ary  = new unsigned short[segCnt+1];
+      dlt_ary  = new unsigned short[segCnt+1];
+      off_ary  = new unsigned short[segCnt+1];
+      head_ary[0] = 0; end_ary[0] = 0xff; dlt_ary[0] = 0;
+      off_ary[0] = (EachSeg+segCnt)*2;
+      i = 1; /* above is english */
+      /* 0x8140 -- 0x9ffc */
+      for (base = 0, start = 0x8140, fnum = EachFont*31;
+          fnum > 0; fnum -= EachFont, start += 256, base += EachFont, i++)
+          {
+          head_ary[i] = start;
+          end_ary[i] =
+              start + ((fnum > EachFont)?EachSeg:((fnum > 63)?(fnum+EachOff):fnum)) - 1;
+          dlt_ary[i] = base;
+          off_ary[i] = (segCnt-i)*2;
+          }
+      /* 0xe040 -- 0xeffc */
+      for (base = EachFont*31, start = 0xe040, fnum = EachFont*16; fnum > 0;
+          fnum -= EachFont, start += 256, base += EachFont, i++)
+          {
+          head_ary[i] = start;
+          end_ary[i] =
+              start + ((fnum > EachFont)?EachSeg:((fnum > 63)?(fnum+EachOff):fnum)) - 1;
+          dlt_ary[i] = base;
+          off_ary[i] = (segCnt-i)*2;
+          }
+      if (i >= segCnt)
+         { cout << "Error at CMAP format4, memory may destroy.\n"; return;}
+      head_ary[i] = end_ary[i] = 0xffff;
+      dlt_ary[i] = 1; off_ary[i] = 0;
+      fmat4.addshort(4); /* format */
+      fmat4.addshort(14+segCnt*8+glyf_index.getlen()); /* len */
+      fmat4.addshort(0);
+      fmat4.addshort(segCnt*2);
+      fmat4.addshort(64); /* segCnt between 32 - 63 */
+      fmat4.addshort(5);  /* log_2(64/2) */
+      fmat4.addshort(segCnt*2-64);
+      for (i = 0; i < segCnt; i++) fmat4.addshort(end_ary[i]); delete end_ary;
+      fmat4.addshort(0);
+      for (i = 0; i < segCnt; i++) fmat4.addshort(head_ary[i]); delete head_ary;
+      for (i = 0; i < segCnt; i++) fmat4.addshort(dlt_ary[i]); delete dlt_ary;
+      for (i = 0; i < segCnt; i++) fmat4.addshort(off_ary[i]); delete off_ary;
+      for (i = 0; i < (short)glyf_index.getlen(); i++)
+          fmat4.addbyte(glyf_index[i]);
+      /* follow make cmap */
+      table *tmp = &ttfTbl[CMAP];
+      tmp->addshort(0); /* Version */
+      tmp->addshort(4); /* #tbl */
+      /* Table 1 (format 0) */
+      tmp->addshort(1); /* Platform ID = 1 -> Macintosh */
+      tmp->addshort(0); /* Encoding ID = 0 -> Roman */
+      tmp->addlong( 36L);
+      /* Table 2 (format 2) */
+      tmp->addshort(1); /* Platform ID = 1 -> Macintosh */
+      tmp->addshort(1); /* Encoding ID = 1 -> Japanese */
+      tmp->addlong( 36L+fmat0.getlen());
+      /* Table 3 (format 2) */
+      tmp->addshort(3); /* Platform ID = 3 -> Microsoft */
+      tmp->addshort(2); /* Encoding ID = 2 -> ShiftJIS */
+      tmp->addlong( 36L+fmat0.getlen());
+      /* Table 4 (format 4) */
+      tmp->addshort(3); /* Platform ID = 3 -> Microsoft */
+      tmp->addshort(2); /* Encoding ID = 2 -> ShiftJIS */
+      tmp->addlong( 36L+fmat0.getlen()+fmat2.getlen());
+      for (i = 0; i < (short)fmat0.getlen(); i++) tmp->addbyte(fmat0[i]);
+      for (i = 0; i < (short)fmat2.getlen(); i++) tmp->addbyte(fmat2[i]);
+      for (i = 0; i < (short)fmat4.getlen(); i++) tmp->addbyte(fmat4[i]);
+      tmp->chksum4();
+      tmp->len = tmp->getlen();
+      }
+ 
+ void make_gidx(bigfirst &gidx)
+      {
+      short i, base = 96;
+      for (i = 0; i < 63; i++, base++) gidx.addshort(base);
+      for (i = 63; i < 64; i++)          gidx.addshort(0);
+      for (i = 64; i < 189; i++, base++)     gidx.addshort(base);
+      for (i = 0; i <= 32; i++)      gidx.addshort( 0);
+      for (; i <= 0x7e; i++)         gidx.addshort(i-32+1);
+      for (; i < 256; i++)           gidx.addshort(0);
+      }
+ #else /* !SJIS */
+ 
  void gene_cmap()
       {
       bigfirst fmat0, fmat2, fmat4, glyf_index;
***************
*** 571,584 ****
  
  void make_gidx(bigfirst &gidx)
       {
!      short base = 96;
!      for (short i = 0; i < 63; i++, base++) gidx.addshort(base);
       for (i = 0; i < 191-157; i++)          gidx.addshort(0);
       for (i = 63; i < 157; i++, base++)     gidx.addshort(base);
       for (i = 0; i <= 32; i++)      gidx.addshort( 0);
       for (; i <= 0x7e; i++)         gidx.addshort(i-32+1);
       for (; i < 256; i++)           gidx.addshort(0);
       }
  
  void gene_basicglyf()
       {
--- 822,836 ----
  
  void make_gidx(bigfirst &gidx)
       {
!      short i, base = 96;
!      for (i = 0; i < 63; i++, base++) gidx.addshort(base);
       for (i = 0; i < 191-157; i++)          gidx.addshort(0);
       for (i = 63; i < 157; i++, base++)     gidx.addshort(base);
       for (i = 0; i <= 32; i++)      gidx.addshort( 0);
       for (; i <= 0x7e; i++)         gidx.addshort(i-32+1);
       for (; i < 256; i++)           gidx.addshort(0);
       }
+ #endif
  
  void gene_basicglyf()
       {
***************
*** 623,629 ****
--- 875,890 ----
       glyf.addshort(XSIZE/2); //hmtx define the kerning, not here
       glyf.addshort(YSIZE-DESCENT);
       glyf.addshort(0x53);
+ #ifdef SJIS
+      {
+          int jis;
+          /* ShiftJIS -> JIS */
+          jis = _mbcjmstojis(ptn_2byte[i*2] * 256 + ptn_2byte[i*2+1]);
+          glyf.addshort(((jis >> 8) - 0x21) * 94 + (jis & 0xff) - 0x21 + 96);
+      }
+ #else
       glyf.addshort(big5(ptn_2byte[i*2], ptn_2byte[i*2+1])+96); //glyf index
+ #endif
       glyf.addshort((unsigned short)(-1*(XSIZE/4)));
            //Move right 1/4, reserved for engfnt opt
       glyf.addshort(0);
