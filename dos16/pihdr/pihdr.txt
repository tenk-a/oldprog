ＰｉＨｄｒ  ver1.53



    PI画像ファイルのヘッダを表示したり変更したりするプログラムです。以下
  のことをするのに使えます。

    ・ざっとヘッダ情報一覧をみたい、とき。
    ・コメントまたはユーザを入れたい、変更したい、削除したい、とき。
    ・ドット縦横比を変更したいとき。
    ・表示開始位置(始点)を変更したいとき。
    ・パレット・データを変更したいとき。
    ・パレット・ファイルを作成したいとき。

  などなど。
    セーブ時に指定を間違えたり、とか、気がかわったので変更したい、という
  場合に、わざわざ画像圧縮までやり直す必要のない変更を行うためにあります。



□  つかいかた

  usage: PiHdr [-opts] file[.Pi]...

    ファイルやオプションは複数指定できます。
    ファイルは、拡張子が PI のものを指定してください。拡張子を指定しなか
  ったり別の拡張子を指定しても、拡張子を .PI にして実行します。
    ファイルは複数指定できワイルド・カード指定もできますが、変更を行うば
  あいはなるべく複数のファイル指定をしないでください。

    ワイルド・カード文字は MS-DOS のものより拡張されており、
      *     0文字以上の任意の文字列に一致
      ?     任意の一文字に一致
      [..]  [ ] 内の文字列のどれか一文字に一致
      [^..] [^ ] 内の文字列以外の一文字に一致
	    括弧内では 0-9 のように'-'による範囲指定も可
	    また、括弧内では他のワイルドカード文字は機能しない
  があります。全角文字にも対応しています。
    また、パスの区切りとして \ だけでなく / も使えます。そのかわり、オプ
  ション指定は - だけで / は使えません。



□  オプション

    オプションは複数指定でき、各ファイルの処理を行う前に調べられます。
  同種のオプションを指定したばあいは後ろにあるものが有効です。

  オプションは以下のものがあります。

-t	    簡単な表示を行います. オプション無指定のばあい、このオプショ
	    ンが指定されたことになります。

-l	    くわしく表示します。

-d	    ファイル名とそのコメントを表示します。

-r	    .RGB ファイルを作成します。 16色のみで、256色は不可です。

-b	    変更時、元のファイルを.BAKファイルにして残さないようにします。
	    変更後のヘッダサイズが変わらないなら直接ファイルを書き換え、
	    サイズが変わるなら元を.BAKにして作成後、.BAKファイルを削除し
	    ます。直接書き換えるばあい、すでにBAKファイルがあっても削除
	    しません。

-y	    変更時、日付を変更しないようにします。

-z	    変更時、確認待ちをせずに、変更を実地します。
-z0	    -z の機能に加え、変更内容の表示も行いません。

-n[r1][,r2] ドット縦横比を r1/r2 に変更します(省略:[0,0])
	    r1=r2 または r1=0ま たは r2=0 なら、r1=r2=0 にします。
	    640*200ライン画像なら(r1,r2)=(2,1)になります。

-i<name>    セーバ機種名を<name>に変更します。nameは4バイトまでです。

-o[x][,y]   始点を変更します(省略:[0,0])
	    (0,0)でもかならず始点情報が生成されます。

-k	    内容にかかわらず機種依存情報を削除します(始点情報も削除)。

-p[rgbfile] パレット・データを rgbfile[.rgb] より読み込みます。16色のみ。
	    256色は不可。rgbfileの指定がないときは pi のファイル名の拡張
	    子を.rgb にして読込みます。
-p-	    パレット・データを削除し、デフォルト・パレットを使うことにし
	    ます。
-8	    パレットをデジタル８色にします(8-15は0-7の内容と同じです).

-h[文字列]  隠れコメントを変更します(省略時:隠れコメント削除)
	    削除以外は使わないほうが無難でせう。

-u[NAME]    ユーザ名を変更します。[NAME]を省くと、ユーザ名を削除します。

-c<file>    コメントを file より読み込み変更します。ローダがどの程度機能
	    するかに依存するのであまり大きなファイルは指定しないでね。

=[文字列]   コメントを変更します。コマンド・ラインの行末で有効ですが、連
	    続する空白は１文字に変換されてしまいます。 とうぜん'='より後
	    ろにオプションもファイル名も指定できません。

-m[magfile] magfile[.mag] のヘッダよりドット比、パレット、コメント（＋ユ
	    ーザ名＋セーバ名）、始点を得て変更します。
	    magfile省略時は、指定されたPiファイル名の拡張子を.mag にした
	    名前が使われます。
	    これはもちろん、mag から pi に変換するのを補助するためにあり、
	    このばあいの Pi ファイルは、mag ローダで表示した画像を同じ名
	    で Pi セーバで圧縮したものを前提にしています。

	    -m は変更系のオプションと同時には指定しないでください。 オプ
	    ションを評価する順番が不定なので、期待した通りにならないばあ
	    いがあります。

	    パレットは、MAG のものをそのままコピーします。Pi と Mag では
	    無効ビットの扱いは違うのですが、有効ビット数の確実な判定方法
	    がないのと、わざわざ変換しなくても実質問題はないので（という
	    ことにして ^^;）このようにしました。

-lm[magfile] magfile のヘッダ情報を表示して -m と同じ動作をします。
	    また、pihdr のコマンドラインにPiファイル名を指定せずに起動す
	    ると、magfile のヘッダ情報の表示のみ行う。
		例) pihdr -lm*
		    カレント・ディレクトリのmagのヘッダ情報表示



□  Pi のヘッダ

    Pi のヘッダには以下の情報があります。
    * 'Pi' の印
    ・ローダで表示されるコメント
    ・ローダで表示されないコメント
    ・デフォルト・パレットを使うか、パレット情報を持っているかのフラグ
    ・ドット縦横比  n1:n2
    * 16色か 256色か
    ・セーバ機種名 (4バイト)
    ・機種依存情報
    * 画像のサイズx*y (ドット)
    ・パレット・データ

  くわしくはPiの仕様書をみてください。

  このうち pihdr では、'・'の項目を変更することができます。



□  始点について

    ぼくが参照した Pi の仕様書では始点情報はヘッダでは定義されてないよう
  でしたが、PI98 で部分セーブしてみるとちゃんと元の一に表示されます。
  セーブしたもののデータを覗いてみると、機種依存領域に格納されていました。
  これは５バイトあり以下のようになります。
    +0  0x01
    +1  x座標の上位バイト
    +2  x座標の下位バイト
    +3  y座標の上位バイト
    +4  y座標の下位バイト
  +1〜+4は問題ないのですが、+0バイト目の内容の 1がどういう意味かわかって
  いません。
    pi98 で200/400ライン,デジタル/アナログ指定をしてセーブをしてみました
  がいずれも 1のままだったので、これは機種依存情報内での情報の数またはフ
  ォーマットのレベルか何かだろーとかってに解釈し、少なくとも始点情報だけ
  ならたえず１だろうと思えます。
    このpihdr ではセーバ機種名にかかわらず、機種依存領域のサイズが 5バイ
  トかつその１バイト目が 0x01 ならば、そのデータを始点情報として扱うこと
  にしました。
    もちろんこれは間違っているかもしれず、始点情報を変更するとPiローダで
  表示できなくなる可能性もあります（ためした限りPi98では大丈夫なようです
  が.. セーバ名チェックもしてないようですし）。
    それから始点の変更を行うとそれまでにあった機種依存情報は破棄されます。



□  複数のファイルに対しいっぺんに変更処理をするばあい

    もともと、変更は、１度に一つしか変更しないつもりで作っていましたが、
  コメントを一括して変更・削除するとか、-mでの変更を一括して行うとかでき
  たら便利だろう、と、とりあえず、複数指定に対応してみました。
    が、チェックはほとんどしてないので、とくにオプションの組み合せによっ
  ては予期せぬことが起こりえます。

    ただでさえ変更は画像ファイルを破壊しかねないのに、誤った指定でワイル
  ドカードを指定していたりすると...



□  ユーザ名について

    Pi は仕様では MAG でのユーザ名に該当する項目がヘッダにないですが、こ
  のpihdrでは、拙作 mg（旧pi2mag,mag2pi）,dopi.exeで採用したユーザ名をサ
ポートします。
    これは、コメントの先頭に"User:"の 5バイトがあるとその直後から改行(CRLF)
  の直前までをユーザ名とし、その改行の直後からをコメントとします。
    かってな私的な仕様拡張ですが、他のローダ等のツールで表示等を行っても
  単にコメントの先頭に "User:"がついてちょっと見苦しい程度で困ることはな
  いでせう。
    もちろん、ユーザ名がないばあいは"User:"の行はありません。



□  -m,-lm による mag ヘッダ読込み

    お察しの通り、このオプションは、mag->pi変換のために用意しました。
    が pihdr v1.52以後に mg（旧mag2pi） という自前で展開圧縮を行う DOS汎
  用のコンバータを作ったのでこのヘッダ読込み機能を使う必要がなくなりまし
  た。
    で、紛らわしいので -m,-lm は削除しようかとも思いましたが、機能ダウン
  するというのも抵抗あるので残すことにしました... だもんで、実際に使われ
  ることはないと思いますし、もはやチェックらしいチェックは行っていないの
  で怖いかもしれません。



□  おわりに

    Pi の資料としては、PiTech.Txt, 98用Piの cのソースを参考にし、また、
  MAG のヘッダは MAGBIBLE.DOC を参考にしました（感謝感謝）

    フリーソフトウェアとします. 非営利なら転載自由で、連絡不要です.
    改造、引用もするのは自由ですが、改造物の再配布では、入手したすべての
  人にオリジナルが存在し改造物であることを最低限伝える必要があり、原作者
  と同じ配布条件でないといけなせん.
    もちろん、作者はいかなる義務も責任も負いません. あとは、まあフリーウ
  ェアの常識の範囲で考えてください^^;

    ほんと、誤指定や PiHdrのバグで画像を破壊する可能性が十分あるので、そ
  うなったときの覚悟はしておいてください。

    あっと。転載してくれたら、どこそこに転載したよ、って可能ならひとこと
  連絡してくださると非常にうれしいです（作者が喜ぶだけで義務ではないよン）
  でもって、バグも連絡していただけるとありがたいです. 代わりに虫取りして
  いただけるともっとうれしい^_^;

						てんか☆
						ﾆﾌﾃｨ･ｻｰﾌﾞ	   NBB00541
