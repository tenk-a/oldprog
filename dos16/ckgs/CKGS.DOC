
ＣｋＧＳ　ver.0.81	--------  Copy-Key Graphic Saver　for PC9801


　　COPYキーで割り込んで現在表示している画面をセーブするためのプログ
　ラムです。

　　利用には危険が伴うので、覚悟が必要です。



□　使い方

　usage: ckgs [-opts] [filename]

　　-v で常駐、-r で解除、-v,-rのない場合は常駐判定を行ないます。

　　CkGS -v で常駐し、その後ターゲット・プログラムを走らせ、セーブす
　る画面のところでCOPYキーを押します。
　　COPYキーを押すとファイル名を聞いてくるのでセーブするファイル名を
　入力してください。ファイル名をいれればその拡張子を .frm にして画像
　をセーブします。ファイル名を指定しなかったばあいはセーブしません。
　終了後元のプログラムに実行を戻します。
　　が、たいていどこかおかしくなります。ハングするだけならまだしも致
　命的な破壊もありえます。一つセーブごとにリセットをかけたほうが無難
　でせう。
　　とくに指定がないばあい DOS のコマンド入力待ちから セーブ画面に移
　り終了して元に戻ると、ハングします。

　　セーブの対象となるのは、基本的にCOPYキーを押した時点でのアクティ
　ブ・ページの 640*400 16色の画面で、ベタファイル .frmファイルに出力
　します。



□　ファイル名

    コマンドラインで指定されたfilenameは最後に指定された一つだけが有
  効で、最初のセーブのときにデフォルトのファイル名として用いられます。



□　オプション

　- または -?
　　　ヘルプを表示します.

　-v[N]
　　　CkGSを常駐し、COPYキーによる割り込みを行なえるようにします。
　　　N が指定されるとCOPYキー割り込み05hの代わりに N(0〜FF)のベクタ
　　を乗っ取ります。Nの値は手抜いてチェックしてません！！
　　　特別なことをしていない限り、05 または06 以外は指定しないでくだ
　　でください（05はCOPYキー, 06はSTOPキーです）.
　　　他を指定すると(21hとか26hとか)致命な破壊が起こること大ありです。
　　　ただしezkeyを常駐しているならezkey -iで CTRL+GRPH+I で int 03h
　　に飛ぶので 03 を指定できます。また、ezkeyを改造して 03h 以外にし
　　たり、他のキーボード・ドライバ等で同様のことができるならその割込
　　を指定できるでせう。
　　　が、そうでないなら、05,06以外は指定しないでください！

　-r[N]
　　　常駐を解除します。N は -l- 指定しかつ-vで 5 以外を指定したとき
　　にその番号を指定する必要があります。
 
　-m
　　　対象とするプログラムが、単にCOPYキーを無効にするために int05h 
　　を書き換えるばあいがあるので、そういうばあいのために、int21hを乗
　　っ取りファンクション・コールが Set Interrupt Vectorで al = 05hな
　　らベクタの変更を行なわないようにします。
　　　ただし対応不十分で妖しいので必要のないかぎり使わないほうが無難
　　です。

　-e
　　　DOSコールと排他的に処理を行なうようにします。
　　　（DOSとの排他的処理について、を参照）

　-l-
　　　この指定のないばあいは、テキストon/offの監視のために int 18hを
　　乗っ取りますが、それを行なわず int 18hを乗っ取らないようにします。
　　　このばあい -t でセーブ後のテキストのon/offを指定してください。
　　　また、int 18h は常駐解除の判定に利用しているので、int 18h がな
　　いばあいの常駐の解除に若干影響します。

　-t[N]
　　　セーブ後のテキスト画面の表示を強制的に on(1)/off(0) します。
　　　セーブ後の状態が戻らないとき必要に応じて指定してください。
　　　-l- 指定時は自動判定しないので必要な場合があると思います。

　-g[N]
　　　セーブ後のグラフィック画面の表示を強制的に on(1)/off(0) します。
　　　セーブ後の状態が戻らないとき必要に応じて指定してください。

　-a[N]
　　　セーブ時のアクティブ・ページを強制的に N(0または1)にします。

　-b[N]
　　　セーブ後のアクティブ・ページを強制的に N(0または1)にします。

　-d
　　　グラフェィック画面０、１の両方をセーブします。
　　　表(０)を.frm で、裏（１）を.frn にしてセーブします。
　　　セーブ後はアクティブ・ページを強制的に表(0)にします。

　-c
　　　セーブ時にグラフィック・チャージャ(GC)が TCRモードになっていた
　　りすると画像がちゃんと読めないので、セーブ前に ポート7chに0x00を
　　ライトして、GC機能をオフにします。
　　　セーブ後、元のプログラムにもどってから不都合があるかもしれませ
　　んが、そのときはあきらめてリセットでもしてください。

  -p
      常駐パレットの内容も一緒にセーブします。



□　常駐と解除について

　　ベクタの書き換えを行うので、常駐物の常駐／解放の順番には気をつけ
  てください。基本的には常駐したのと逆の順番に解放しませう。
　　でもって他の常駐物との相性にも気をつけませう。

　　常駐時、最大以下の３つのベクタを乗っ取ります。
　　
　・int 05h　セーブのための（COPYキーの）割り込み　int 05h
　　　　　　 （-v[N]で05以外に変更可）
　・int 18h　セーブ後の状態復帰のためのテキストのon/offの監視
　　　　　　 （-l- で乗っ取らない）
　・int 21h　int05hベクタの書換の取消(-m)またはDOSコールと排他的に処
　　　　　　 理するため(-e)。（-mか-eの指定のない限り乗っ取らない）


　　常駐判定は、まず、int 18h のアドレスを確かめ、もしそうならそこか
　ら十数バイトを比較して確認します。一致すれば、常駐しているものとし、
　一致しなければ、-l- でint 18h は乗っ取らなかったものとしてこんどは
　int 05h(変更されていれば変更されたもの)のアドレスを確かめ、18hと同
　様に比較して確かめます。
　
　　解除するとき、もし -l- でかつ -vN で 05 以外が指定されると、-rだ
　けでは比較するべきベクタが見つからないので、-rN で-vN で指定した番
　号を指定する必要があります。
　
　　int 21h はデフォルトでは利用しないこともあって、現在のところ常駐
　判定には用いていません。
　
　
　　-l- を指定すると、 常駐判定では -vN のベクタのみを対象とするので
　-vN の指定を変えて指定すると、よくもわるくも多重に常駐できてしまい
　ます。メモリは食いますがCOPYキーとSTOPキーとを同時に有効にできたり
　するので、あえて禁止していません（てできませんが）。もちろん、解除
  の順番等には十分気をつけてください。



□　セーブ画面の指定について

　　セーブの対象となる画面は 640*400の現在のアクティブ・ページです。
　　オプション -a,-b,-w の指定のない限りページ切り替え等は行なわない
　ので割り込時のアクティブ・ページをセーブすることになります。
　　もしアクティブ・ページにセーブする画像がないばあいは、-a,-d で強
　制的にセーブするページをアクティブ・ページにしてやる必要があります。
　　ただし変更を行なうとセーブ後もとのプログラムに戻ったときに不都合
　が生じる可能性が大きいので、セーブ後のアクティブ・ページも指定でき
　るよう -b オプションがあります。



□　セーブ後の画面表示の on/off について

　　セーブ名入力のとき、テキスト画面を裏テキストに退避しグラフィック
　表示をオフにします。
    セーブ後元に戻すにあたって元の画面がどうであったかについては、テ
  キスト画面は int 18h を乗っ取ってテキストのon/off命令を監視し、 グ
  ラフィック画面は BIOS のワークを見ています。
　　が、BIOSを経由せず直接ハードをコントロールされるとうまくいかない
　ので、そういうときは、オプションで強制的にセーブ後の状態を指定して
　やります。
    なお、カーソル位置の退避にはエスケープシーケンスの機能を用いてい
  ます。

    もし、裏テキストを元のプログラムが使っていたり、エスケープシーケ
  ンスのカーソル位置のセーブ機能を利用していたりすると、不都合が生じ
  るかもしれません。



□　DOSとの排他的処理について

　　　-eの指定のないばあいは、COPYキーを押すタイミングによっては致命
　　的なことになる可能性が高く、また、DOS のコマンドラインでCOPYキー
　　を押してセーブするとDOSに戻らずハングします。
　　　-eの指定をすれば、DOS のコマンドラインでセーブ画面に移っても元
　　に戻ることがまあできます（指定しない場合よりかマシというだけで、
    うまくいかないばあいもある）
　　　が、-eの指定のないばあい、COPYキーが押された時点で即セーブ画面
　　になりますが、これが指定されると現在実行しているプログラムが次に
　　DOS のファンクション・コールを行なうまで待ちます。そのためなかな
　　かセーブ画面にならなかったり最悪全然セーブできなかったりします。
　　　用途にあわせてお選びください。



□　frmファイルについて

    セーブしたファイルは、以下の様な構造になっています。

        VRAM B プレーン 640/8 * 400 =  32000
        VRAM R プレーン 640/8 * 400 =  32000
        VRAM G プレーン 640/8 * 400 =  32000
        VRAM I プレーン 640/8 * 400 =  32000
      （RGB パレット    3 * 16      =     48    -p指定時のみ）
      （計                          = 128000(+48)）

  ９８のVRAMをベタで出力しているだけです。RGBパレットはRGBパレット・
  ファイルと同じ構造です。

  frmファイルはMPSのUNDO用に生成されるファイルを参考にしたのですが、
  もとはエスキースで使われているフォーマットらしいと聞いたような気も
  するがさだかでない... b1,r1,g1,(rgb)の３つ(４つ)もファイルを生成す
  るのはばからしいので、ベタにまとめて出力するのにどうせならと、 frm
  にあわせました。
  でもRGB ファイルを後ろに付加するのはかってにやったので、同じ拡張子
  の別もの、ということにして逃げることにしよう^^;



□  常駐パレットについて

    -pを指定すると常駐時に常駐パレットが探し、見つかればセーブ時に常
  駐パレットの内容を一緒にセーブするようにします（.frmファイルの仕様
  をかってに拡張？してファイルの最後に付加しています）。
    現在のパレットを読み出すことは９８のハードの都合上できないのでそ
  の代わりです。
    もちろん、何もしなければ現在の画像にパレットは一致しませんが、他
  のツールと併用するばあいに便利かもしれないので行なうようにしました。

　　常駐パレットは起動時にのみ行ない、セーブ時は見つかったアドレスを
  用いるのみなので、Ckgs常駐中は常駐パレットを解放してはいけません。



□　このプログラムの元ネタについて

　　このプログラムはＮＣＣ−１７０１Ａ（向笠弘二）氏作のパレット・ト
  レーサ trcpal v1.01 の画面セーブ関係をおおいに参考して作成しました。
  別のいいかたをすれば、その部分をそのまんまパクったともいいます^^;
    知らずに作っても似たようなもんになるだろし、同様のコマンドが雑誌
  （ザベ）とかにも載っていたし... けど、細かいが大事な処理、画面 on/
  offの判定はいいとしても、 DOSとの排他的処理なんかはやっぱり trcpal
  をみてなかったらぼくはやってなかったろうし(できなかったろうし)^^;
    まあ、贋作盗作です... と卑屈になるほどでもないか... 改造物といっ
  たほうがよさそだな（どっちにしろ無断なのだけど^^;）。
    実際trcpalを改造していてめんどくさくなって作り直したのだし(^_^;)
  パレット・トレーサ機能のいらない場合ぐらいは HSBが使えたらいいなあ、
  とか、セーブ画面の指定等もしたいとか思って作ったのでした。



□　パレットの収得について

    パレットのトレース機能は付いてないので、パレットは別途用意する必
  要あります。
    そんときは、trcpal等のパレット・トレーサを用いるとか(自爆)、prgb
  等で画像ファイルから直接パレット・データを抜き出して用意してくださ
  い。



□　おわりに

　　このプログラムはかなり危険なので覚悟して使ってください。
　　安全対策は不十分です。ぼくが、どう処理したらいいか、知らないため
  です^^;
　　ハード・ディスク・クラッシュくらい起こるものとして、対策しておき
  ませう。
  （タイマ割り込みが狂うことはよくあること。再起動しても表示が妙に遅
  く処理が重そうなら、date,time コマンドでただしい年月日、時分秒を設
  定すると直るかも）

    気合いは入ってないので、常駐サイズを減らそうと努力しなかったので
  は機能の割に大きく感じるかもしれません。trcpal と比べるととくに...

    trcpalと作者の向笠氏には感謝感謝です。一から自作する根性のないぼ
  くにはソース付きのソフトはありがたいものです。原作者の苦労のおかげ
  で改造者はかなり楽にプログラムで遊べます（でも無断なやつ^^;）。

    著作権についてえらそうなこといえないソフトですが、とりあえずフリ
  ーソフトウェアということにします。無料の草の根ＢＢＳでゲーム画像等
  のブッコの話題に寛大なとこなら再配布可です。ブッコぬき等に冷たいと
  ころは不可です（配布条件が同じで、元ネタについてちゃんと記入すれば
  改造物の配布はぼくはかまわないです）
  
    利用にあたっては使用者の責任で利用してくださいね。作者や改変者、
  配布者はいかなる責任も義務も負いません。
  （でも、バグは知らせてもらえるとありがたいです）


					てんか☆
					二の次(贋作)倶楽部	#31
					Magical-BBS 大坂	#84
